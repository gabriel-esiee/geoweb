<!DOCTYPE html>
<html lan="en">
	<head>
		<title>Semestral project</title>

        <script type="text/javascript" src="scripts/leaflet.js"></script>
        <script type="text/javascript" src='scripts/leaflet.mask.js'></script>
        <script type="text/javascript" src='events.js'></script>

        <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&display=swap">
		<link rel="stylesheet" href="style/leaflet.css"/>
        <link rel="stylesheet" href="style/style.css">
	</head>
	<body>
        <div id="map"></div>

        <div class="modal" id="modal">
            <div class="background" id="modal-bg"></div>
            <div class="card">
                <div class="grid">
                    <img src="" alt="" id="modal-img">
                    <div class="modal-content">
                        <h2 class="title" id="modal-title">Title of the event</h2>
                        <h3 class="subtitle" id="modal-date">1900</h3>
                        <p id="modal-desc">Description of the event here...</p>
                        <button class="close" id="modal-close">Quitter</button>
                    </div>
                </div>
            </div>
        </div>

        <form class="settings">
            <div class="grid">
                <h2 class="date-title">Filter event by date (<span id="min-date-text"></span>-<span id="max-date-text"></span>)</h2>
                <h2 class="type-title">Filter event by type (<span id="type-text"></span>)</h2>
                <div class="date-range">
                    <input id="slider_one" type="range" value="1800" min="1000" max="2024"/>
                    <input id="slider_two" type="range" value="2000" min="1000" max="2024"/>
                </div>
                <div class="type-selection">
                    <label>
                        <input type="checkbox" id="building-checkbox" checked value="building">
                        Building
                    </label>
                    <label>
                        <input type="checkbox" id="battle-checkbox" checked value="battle">
                        Battle
                    </label>
                    <label>
                        <input type="checkbox" id="treaty-checkbox" checked value="treaty">
                        Treaty
                    </label>
                    <label>
                        <input type="checkbox" id="other-checkbox" checked value="other">
                        Other
                    </label>
                </div>
            </div>
        </form>

		<script>

            // Modal.

            function openModal() {
                document.getElementById('modal').classList.add('active');
            }

            function closeModal() {
                document.getElementById('modal').classList.remove('active');
            }

            document.getElementById('modal-close').addEventListener('click', function(e){
                closeModal();
            });

            document.getElementById('modal-bg').addEventListener('click', function(e){
                closeModal();
            });

            // Range slider.

            const slider_one = document.getElementById('slider_one');
            const slider_two = document.getElementById('slider_two');
            const min_text_span = document.getElementById('min-date-text');
            const max_text_span = document.getElementById('max-date-text');

            var min = slider_one.value;
            var max = slider_two.value;

            slider_one.addEventListener('input', function() {
                update_min_max_values(slider_one.value, slider_two.value);
            });

            slider_two.addEventListener('input', function() {
                update_min_max_values(slider_one.value, slider_two.value);
            });

            function update_min_max_values(slider_one_value, slider_two_value) {
                min = Math.min(slider_one_value, slider_two_value);
                max = Math.max(slider_one_value, slider_two_value);
                
                min_text_span.textContent = min;
                max_text_span.textContent = max;

                update_markers();
            }

            // Type from selection.

            let selected_types = [];

            const building_checkbox = document.getElementById("building-checkbox");
            const battle_checkbox = document.getElementById("battle-checkbox");
            const treaty_checkbox = document.getElementById("treaty-checkbox");
            const other_checkbox = document.getElementById("other-checkbox");
            const type_text_span = document.getElementById("type-text")

            building_checkbox.addEventListener('change', update_selected_types);
            battle_checkbox.addEventListener('change', update_selected_types);
            treaty_checkbox.addEventListener('change', update_selected_types);
            other_checkbox.addEventListener('change', update_selected_types);

            function update_selected_types() {
                selected_types = [];
                count = 0;

                if(building_checkbox.checked) {
                    selected_types.push('building');
                    count++;
                }

                if(battle_checkbox.checked) {
                    selected_types.push('battle');
                    count++;
                }

                if(treaty_checkbox.checked) {
                    selected_types.push('treaty');
                    count++;
                }

                if(other_checkbox.checked) {
                    selected_types.push('other');
                    count++;
                }

                type_text_span.textContent = count;

                update_markers();
            }

            // Leaflet map.

            let map = L.map("map", {
                center: [45, 4],
                zoom: 8
            });

            map.on('click', function(e) {
                const lat = e.latlng.lat.toFixed(5);
                const lng = e.latlng.lng.toFixed(5);
                console.log(`Coordinates: ${lat}, ${lng}`);
            });

            const tiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 20
            }).addTo(map);

            const mask = L.mask('https://france-geojson.gregoiredavid.fr/repo/regions/auvergne-rhone-alpes/region-auvergne-rhone-alpes.geojson', {
                restrictBounds: false,
                weight: 0,
                fillColor: 'black',
                fillOpacity: 0.55
            }).addTo(map);

            const default_icon = L.icon({
                iconUrl: 'assets/images/information.png',
                iconSize: [32, 32],
                iconAnchor: [16, 16],
                popupAnchor: [16, 16]
            });

            const building_icon = L.icon({
                iconUrl: 'assets/images/building.png',
                iconSize: [32, 32],
                iconAnchor: [16, 16],
                popupAnchor: [16, 16]
            });

            const battle_icon = L.icon({
                iconUrl: 'assets/images/battle.png',
                iconSize: [32, 32],
                iconAnchor: [16, 16],
                popupAnchor: [16, 16]
            });

            const treaty_icon = L.icon({
                iconUrl: 'assets/images/treaty.png',
                iconSize: [32, 32],
                iconAnchor: [16, 16],
                popupAnchor: [16, 16]
            });

            function get_type_icon(type) {
                if(type == 'building')
                    return building_icon;
                else if(type == 'battle')
                    return battle_icon
                else if(type == 'treaty')
                    return treaty_icon
                else
                    return default_icon
            }

            let markersLayer = L.layerGroup().addTo(map);
            let markersList = []

            function initialize_markers() {
                for (let i = 0; i < events.length; i++) {
                    const event = events[i];
                    
                    var marker = L.marker(event['coordinates'], {
                        title: event['title'],
                        icon: get_type_icon(event['type'])
                    })

                    marker.attached_event_id = i;

                    marker.on('click', function(e) {
                        const attached_event = events[e.target.attached_event_id];

                        document.getElementById('modal-title').textContent = attached_event['title'];
                        document.getElementById('modal-img').setAttribute('src', attached_event['image']);
                        document.getElementById('modal-date').textContent = attached_event['date'];
                        document.getElementById('modal-desc').textContent = attached_event['description'];

                        openModal();
                    });

                    markersList.push(marker);
                }
            }
            
            function should_draw_event(event) {
                // An event should be included if its date is included in range slider 
                // and if its type is selected.
                if(event['date'] >= min && event['date'] <= max) {
                    if(selected_types.includes(event['type']) == true) {
                        return true;
                    }
                }
                return false;
            }

            function update_markers() {
                markersLayer.clearLayers();

                markersList.forEach(marker => {
                    const attached_event = events[marker.attached_event_id];
                    
                    if(should_draw_event(attached_event) == true) {
                        markersLayer.addLayer(marker);
                    }
                });
            }

            initialize_markers();
            update_min_max_values(slider_one.value, slider_two.value);
            update_selected_types();

		</script>
	</body>
</html>