<!DOCTYPE html>
<html lan="en">
	<head>
		<title>Semestral project</title>

        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
        <script type="text/javascript" src='leaflet.mask.js'></script>
        <script type="text/javascript" src='events.js'></script>

		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
        <link rel="stylesheet" href="style.css">
	</head>
	<body>

        <div id="map"></div>

        <div class="modal" id="modal">
            <div class="background" id="modal-bg"></div>
            <div class="card">
                <header>
                    <p class="title"></p>
                </header>
                <section>
                    <h3 class="title" id="modal-title">Title of the event</h3>
                    <p class="subtitle" id="modal-date">1900</p>
                    <img class="image is-5by3 pb-4" id="modal-img" src="https://bulma.io/assets/images/placeholders/800x480.png" alt="The image is loading...">
                    <p id="modal-desc">Description of the event here...</p>
                </section>
                <footer>
                <button class="close" id="modal-close">Quitter</button>
                </footer>
            </div>
        </div>

        <form class="settings">
            <div class="grid">
                <input id="slider_one" type="range" value="500" min="0" max="2024"/>
                <input id="slider_two" type="range" value="1900" min="0" max="2024"/>
                <div class="type-section">
                    <label>
                        <input type="checkbox" id="building-checkbox" checked value="building">
                        Building
                    </label>
                    <label>
                        <input type="checkbox" id="battles-checkbox" checked value="battles">
                        Battles
                    </label>
                </div>
            </div>
        </form>

        <script type="text/javascript" src="range_slider.js"></script>

		<script>

            // Modal.

            function openModal() {
                document.getElementById('modal').classList.add('active');
            }

            function closeModal() {
                document.getElementById('modal').classList.remove('active');
            }

            document.getElementById('modal-close').addEventListener('click', function(e){
                closeModal();
            });

            document.getElementById('modal-bg').addEventListener('click', function(e){
                closeModal();
            });

            // Range slider.

            const slider_one = document.getElementById('slider_one');
            const slider_two = document.getElementById('slider_two');

            var min = slider_one.value;
            var max = slider_two.value;

            slider_one.addEventListener('input', function() {
                update_min_max_values(slider_one.value, slider_two.value);
            });

            slider_two.addEventListener('input', function() {
                update_min_max_values(slider_one.value, slider_two.value);
            });

            function update_min_max_values(slider_one_value, slider_two_value) {
                min = Math.min(slider_one_value, slider_two_value);
                max = Math.max(slider_one_value, slider_two_value);

                update_markers();
            }

            // Type from selection.

            let selected_types = [];

            const building_checkbox = document.getElementById("building-checkbox");
            const battles_checkbox = document.getElementById("battles-checkbox");

            building_checkbox.addEventListener('change', update_selected_types);
            battles_checkbox.addEventListener('change', update_selected_types);

            function update_selected_types() {
                selected_types = [];

                if(building_checkbox.checked) {
                    selected_types.push('building');
                }

                if(battles_checkbox.checked) {
                    selected_types.push('battle');
                }

                update_markers();
            }

            // Leaflet map.

            let map = L.map("map", {
                center: [45, 4],
                zoom: 8
            });

            const tiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 20
            }).addTo(map);

            const mask = L.mask('https://france-geojson.gregoiredavid.fr/repo/regions/auvergne-rhone-alpes/region-auvergne-rhone-alpes.geojson', {
                restrictBounds: false,
                weight: 0,
                fillColor: 'black',
                fillOpacity: 0.75
            }).addTo(map);

            let markersLayer = L.layerGroup().addTo(map);
            let markersList = []

            function initialize_markers() {
                for (let i = 0; i < events.length; i++) {
                    const event = events[i];
                    
                    var marker = L.marker(event['coordinates'], {
                        title: event['title']
                    })

                    marker.attached_event_id = i;

                    marker.on('click', function(e) {
                        const attached_event = events[e.target.attached_event_id];

                        document.getElementById('modal-title').textContent = attached_event['title'];
                        document.getElementById('modal-img').setAttribute('src', attached_event['image']);
                        document.getElementById('modal-date').textContent = attached_event['date'];
                        document.getElementById('modal-desc').textContent = attached_event['description'];

                        openModal();
                    });

                    markersList.push(marker);
                }
            }
            
            function should_draw_event(event) {
                // An event should be included if its date is included in range slider 
                // and if its type is selected.
                if(event['date'] >= min && event['date'] <= max) {
                    if(selected_types.includes(event['type']) == true) {
                        return true;
                    }
                }
                return false;
            }

            function update_markers() {
                markersLayer.clearLayers();

                markersList.forEach(marker => {
                    const attached_event = events[marker.attached_event_id];
                    
                    if(should_draw_event(attached_event) == true) {
                        markersLayer.addLayer(marker);
                    }
                });
            }

            initialize_markers();
            update_min_max_values(slider_one.value, slider_two.value);
            update_selected_types();

		</script>
	</body>
</html>